# 랩 2 - 연습 2 - 조건부 액세스

조건부 액세스 정책에 따라 특정 위치 및 디바이스에서만 액세스할 수 있음에도 불구하고 직원이 알 수 없는 위치에서 Microsoft 365에 액세스하고 있음을 발견했습니다. 조사 결과 이러한 직원들은 대중교통을 이용하여 사무실에서 집으로 귀가하는 동안 Microsoft 365에 액세스하고 있는 것으로 나타났습니다. 이 행위는 업계 규정을 위반한 것이며, 지속적인 액세스 권한 평가를 사용하여 규정 위반을 방지하고자 합니다. 또한 이전 연습에서 준비한 인증 강도를 구현하여 고객 데이터를 처리하는 특정 애플리케이션을 보호하려고 합니다. 

## 1부: 솔루션 설계(필수)

이 작업에서는 Contoso Ltd.가 직면한 위험을 해결하기 위한 개념을 설계합니다.

### 디자인 접근 방법

초기 단계에서는 설명된 문제에 따라 요구 사항을 분석하고, 목표를 이해하고, 요구 사항을 정의합니다.

제공된 사용 사례에 따라 다음 요구 사항을 설명할 수 있습니다.

- 안전하지 않은/알 수 없는 위치에서의 액세스 제한
- 중요한 정보를 포함하는 앱에 대한 강력한 인증 필요

두 번째 단계에서는 Contoso Ltd.의 기존 환경을 검사합니다. Microsoft Entra ID는 Entra ID 조건부 액세스 정책을 사용하여 사용자 액세스를 관리하고 제한하는 솔루션을 제공합니다. 어떤 컨트롤과 정책이 이미 존재하는지를 조사합니다. Entra ID 포털을 사용하여 현재 구성 및 정책을 검토하고 조정이 필요한지 또는 새 정책을 구현해야 하는지 확인합니다.

세 번째 단계는 솔루션의 개념을 만드는 것입니다. 조사 후 신뢰할 수 있는 네트워크가 아직 구성되지 않았으며 현재 정책이 정의된 요구 사항을 충족하지 않음이 밝혀졌습니다. 따라서 새로운 조건부 액세스 정책 집합이 필요합니다. 

### 제안된 솔루션

|요건|솔루션|작업 플랜:|
|----|----|----|
|안전하지 않은/알 수 없는 위치에서의 액세스 제한|Entra ID 조건부 액세스 정책|현재 회사의 네트워크를 신뢰할 수 있는 네트워크로 정의하고 이 네트워크 내 디바이스에 대한 액세스를 제한합니다.|
|중요한 정보를 포함하는 앱에 대한 강력한 인증 필요|Entra ID 조건부 액세스 정책|SMS 및 음성과 같은 안전하지 않은 인증 방법을 제외하는 강화된 인증 강도(방금 생성)가 필요한 중요한 애플리케이션으로 범위가 지정된 새 조건부 액세스 정책을 만듭니다.|

## 파트 2: 솔루션 구현(선택 사항)

### 작업 1 - 신뢰할 수 있는 네트워크 만들기

이 작업에서는 VM의 외부 IP 주소를 사용하여 명명된 위치를 만들어 다음 작업의 조건부 액세스 정책에서 사용 가능한 신뢰할 수 있는 네트워크를 정의합니다. 컴퓨터가 회사 네트워크 내에 있으므로 이 주소를 사용합니다.

1. 클라이언트 1 VM(LON-Sc1)에 **lon-sc1\admin** 계정으로 로그인합니다. 암호는 랩 호스팅 공급자가 제공합니다.
2. 마우스 오른쪽 단추를 눌러 시작 메뉴를 선택하여 **PowerShell** 창을 연 다음 **Windows PowerShell**을 선택합니다.
3. 다음 cmdlet을 입력하여 현재 외부 IP 주소를 확인합니다.
    ```powershell
    curl ifconfig.me | Select-String -Pattern '.'
    ```
4. PowerShell에서 반환된 IP 주소를 적어 둡니다.
5. **Microsoft Edge**를 열고 주소 표시줄을 선택한 다음 **https://entra.microsoft.com**(으)로 이동하여 Entra ID 포털에 **MOD 관리자**(admin@WWLxZZZZZZ.onmicrosoft.com)로 로그인합니다(ZZZZZZ는 랩 호스팅 공급자가 제공한 고유 테넌트 ID). 관리자의 암호는 랩 호스팅 공급자가 제공합니다.
6. 로그인 상태를 유지하시겠습니까? 대화 상자에서 이 메시지를 다시 표시 안 함 체크박스를 선택하고 아니요를 선택합니다.
7. 브라우저에 기본 전역 관리자 자격 증명을 저장하지 않으려면 안 함을 선택하여 하단에서 암호 저장 대화 상자를 닫습니다.
8. 왼쪽 탐색 창에서 **보호** > **조건부 액세스** > **명명된 위치**로 이동합니다.
9. **IP 범위 위치**를 선택합니다.
10. **신뢰할 수 있는 contoso 네트워크**라는 이름을 입력합니다.
11. **신뢰할 수 있는 위치로 표시**를 선택합니다.
12. **+** 을(를) 선택하여 **4단계**에서 적어둔 IP 주소를 추가합니다.
13. 입력은 ``168.245.***.***/32`` (***은 랩 호스팅 공급자에 따라 다를 수 있음)(와)과 유사해야 합니다.
14. **추가**를 선택합니다.
15. **만들기**를 실행합니다.

이제 회사의 네트워크 외부 액세스를 제한하는 데 사용할 수 있는 회사의 외부 IP 주소와 신뢰할 수 있는 위치를 정의했습니다.

### 작업 2 - 범위가 제한된 새 조건부 액세스 정책 만들기

신뢰할 수 있는 네트워크를 성공적으로 만들었으므로 이제 이를 사용하여 개인 사용자에 제한된 범위로 회사 네트워크 외부의 액세스를 제한하는 조건부 액세스 정책을 만들어 Entra ID의 회사 전체 계정 잠금을 테스트하고 방지할 수 있습니다.

1. 계속 Entra ID 포털 **https://entra.microsoft.com**에 로그인된 상태이어야 합니다.
2. 왼쪽 탐색 창에서 **보호** > **조건부 액세스** > **정책**으로 이동합니다.
3. **+새 정책 만들기**를 선택합니다.
4. **신뢰할 수 있는 네트워크 외부에 액세스 차단**이라는 이름을 입력합니다.
5. **0명의 사용자 및 그룹이 선택됨**을 선택합니다.
6. **포함** 아래에서 **사용자 및 그룹 선택**을 선택하고 **사용자 및 그룹**을 선택합니다.
7. 정책의 유일한 테스트 사용자로 **Allan Deyoung**을 선택합니다.
8. **대상 리소스를 선택하지 않음**을 선택하고 **포함**에서 **모든 클라우드 앱**을 선택합니다.
9. **0개의 조건이 선택됨**을 선택하고 **위치** 아래에서 **구성되지 않음**을 선택합니다.
10. **예**를 선택하여 위치 조건을 구성합니다.
11. **포함**에서 **모든 위치**를 선택합니다.
12. **제외**에서 **신뢰할 수 있는 모든 위치**를 선택합니다.
13. **권한 부여**에서 **0개의 제어가 선택됨**을 선택하고 **액세스 권한 부여**에서 **액세스 차단**으로 전환합니다.
14. **세션**에서 **0개의 제어가 선택됨**를 선택합니다.
15. **지속적인 액세스 권한 평가를 사용자 지정**을 사용하도록 설정하고 **사용 안 함**에서 **위치 정책을 엄격하게 적용**으로 전환하고 아래쪽에서 **선택**을 선택하여 확인합니다.
16. 이제 아래쪽의 컨트롤 막대를 사용하여 정책을 사용하도록 설정하고 **만들기**를 선택합니다.

이제 사용자 고유의 테스트 사용자 계정에만 영향을 주는 신뢰할 수 있는 네트워크 외부의 액세스를 제한하도록 CA 정책을 만들고 사용하도록 설정했습니다.

### 작업 3 - 구성된 정책 테스트

회사의 모든 클라우드 애플리케이션에 대한 액세스를 제한하는 조건부 액세스 정책을 만들었으므로 액세스가 여전히 가능한지 확인해야 합니다.

>[!CAUTION] 경고! 이 작업은 설명을 위해 상당히 축약되어 있습니다! 실제 시나리오에서는 더 크고 대표적인 그룹을 사용하고 더 긴 테스트 기간을 수행하여 예측할 수 없는 인시던트가 결과를 왜곡하지 않도록 합니다.

1. **Microsoft Edge** 브라우저에서 작업 표시줄 아이콘을 오른쪽 마우스 단추로 선택하여 새 **InPrivate** 창을 연 다음 **새 InPrivate 창**을 선택합니다.
2. 주소 표시줄을 선택하고 **https://portal.microsoft.com**로 이동한 다음 **Allan Deyoung**alland@WWLxZZZZZZ.onmicrosoft.com로 M365 Portal에 로그인합니다(여기서 ZZZZZZ는 랩 호스팅 공급자가 제공하는 고유 테넌트 ID임). 사용자의 암호는 랩 호스팅 공급자가 제공해야 합니다.
3. 로그인 상태를 유지하시겠습니까? 대화 상자에서 이 메시지를 다시 표시 안 함 체크박스를 선택하고 아니요를 선택합니다.
4. 브라우저에 기본 전역 관리자 자격 증명을 저장하지 않으려면 안 함을 선택하여 하단에서 암호 저장 대화 상자를 닫습니다.
5. 로그인에 성공했기 때문에 **InPrivate** 창을 닫을 수 있습니다.
6. Entra ID 포털 **https://entra.microsoft.com**에 계속 로그인된 상태인 Edge 브라우저 창으로 다시 전환합니다.
7. 왼쪽 탐색 창에서 **보호** > **조건부 액세스** > **모니터링** > **로그인 로그**로 이동합니다.
8. **필터 추가**를 선택하고 **Allan Deyoung** **사용자**로 필터링합니다.
9. **Allan Deyoung**의 최신 로그 항목을 선택합니다.
10. **조건부 액세스** 탭에서 **신뢰할 수 있는 네트워크 외부의 액세스 차단**을 선택합니다.
11. **사용자** 할당을 선택하면 **직접 할당**과 **일치**하는 할당이 표시됩니다.
12. **애플리케이션** 할당을 선택하면 **포함된 모든 앱**과 **일치**하는 애플리케이션 할당이 표시됩니다.
13. 또한 **위치** 조건이 제외된 신뢰할 수 있는 네트워크 내에 있으므로 **일치하지 않는 것**을 확인할 수 있습니다.
다른 외부 IP 주소가 있는 네트워크에서 로그인하려고 하면 이 조건이 부합하고 로그인 시도를 차단합니다.
14. **조건부 액세스 정책 세부 정보** 및 **활동 세부 정보: 로그인**을 닫습니다.

이제 회사의 네트워크 내에서 모든 클라우드 애플리케이션에 대한 액세스를 성공적으로 테스트하고 확인했습니다. 또한 로그인 로그를 확인하여 정책이 의도한 대로 작동하는지 확인하고 올바른 할당 및 조건을 사용하여 회사 네트워크 외부에서 클라우드 애플리케이션에 대한 액세스를 제한했습니다.

### 작업 4 - 회사 차원의 정책 출시

이전 작업에서 성공적으로 테스트한 후에는 이제 회사 전체에서 정책을 사용하도록 설정할 수 있습니다. 이 작업을 수행하려면 기존 정책의 사용자 범위를 편집합니다.

>[!CAUTION] 경고! 이 작업에서 구현된 동작으로 인해 계정 잠금이 발생할 수 있습니다.
생산적이고 실제적인 시나리오에서는 이 정책에서 제외된 긴급 관리자 계정이 하나 이상 있는지 확인합니다. 

1. 계속 Entra ID 포털 **https://entra.microsoft.com**에 로그인된 상태이어야 합니다.
2. 왼쪽 탐색 창에서 **보호** > **조건부 액세스** > **정책**으로 이동합니다.
3. **신뢰할 수 있는 네트워크 외부의 액세스 차단** 정책을 선택합니다.
4. 사용자 아래에서 **포함된 특정 사용자**를 선택합니다.
5. **모든 사용자**를 선택합니다.
6. 창 아래쪽에 표시된 경고에서 **이 정책에서 현재 사용자 admin@WWLxZZZZZZ.onmicrosoft.com 제외**를 선택합니다.
7. **저장**을 선택합니다.

이제 사용자가 신뢰할 수 있는 네트워크 외부(회사의 외부 IP 주소로 정의함)에서 로그인하지 못하도록 하는 활성 작업 조건부 액세스 정책을 구성했습니다. 이 테스트는 제한된 사용자 범위를 사용하여 모든 클라우드 애플리케이션에 계속 액세스한 상태로 수행되었습니다. 마지막으로 모든 사용자에게 CA 정책을 롤아웃했습니다.

신뢰할 수 있는 네트워크 외부에서의 액세스를 성공적으로 제한했습니다.

### 작업 5 - Salesforce용 MFA 필요

이 작업에서는 CA 정책을 만들어 Salesforce에 로그인할 때 이전 연습에서 만든 인증 강도를 적용합니다. 

>[!IMPORTANT] 중요: 이 작업은 테스트 단계를 건너뜁니다. 실제 시나리오에서는 이전 작업에서 볼 수 있듯이 제한된 사용자 범위로 먼저 테스트하고 성공적인 테스트 단계 후에 전체 롤아웃을 수행합니다.

1. 계속 Entra ID 포털 **https://entra.microsoft.com**에 로그인된 상태이어야 합니다.
2. 왼쪽 탐색 창에서 **보호** > **조건부 액세스** > **정책**으로 이동합니다.
3. **+ 새 정책**을 선택합니다.
4. **Salesforce 인증 강도**라는 이름을 입력합니다.
5. **0명의 사용자 및 그룹이 선택됨**을 선택합니다.
6. **포함** 아래에서 **사용자 및 그룹 선택**을 선택하고 **사용자 및 그룹**을 선택합니다.
7. 정책에 대한 유일한 테스트 사용자로 Sales에서 **Alex Wilber**를 선택합니다.
8. **대상 리소스를 선택하지 않음**을 선택하고 **포함**에서 **앱 선택**을 선택합니다.
9. **선택**에서 **없음**을 선택하고 **Salesforce**를 검색합니다.
10. **선택**을 사용하여 선택 사항을 확인합니다.
11. **권한 부여**에서 **0개의 제어가 선택됨**을 선택하고 **인증 강도 필요**를 사용하도록 설정합니다.
12. 사용자 지정 생성 인증 강도 **강화 MFA**를 선택하고 **선택** 단추를 사용하여 확인합니다.
13. 이제 아래쪽에 있는 컨트롤 막대를 사용하여 정책을 **켜기**로 설정하고 **만들기**를 선택합니다.
14. 제한된 사용자 범위의 테스트 단계가 성공적으로 완료되면 **Salesforce 인증 강도**를 선택합니다.
15. 사용자 아래에서 **포함된 특정 사용자**를 선택합니다.
16. **모든 사용자**를 선택합니다.
17. **저장**을 선택합니다.

이제 SMS OTP를 제외한 Salesforce에 인증 강도 정책을 적용하여 SMS 가로채기를 사용하는 성공적인 공격을 방지하는 CA 정책을 만들었습니다. 
